 <!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="apple-touch-icon" href="https://i.ibb.co/kVrdspsT/Barber-note-pro.jpg">
    <title>Barber Note Pro v.3.3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
    :root { 
        --primary: #6366f1; --accent: #0ea5e9; --danger: #ef4444; --success: #22c55e; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --border: #e2e8f0;
    }
    * { box-sizing: border-box; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; overflow-x: hidden; }
    .container { padding: 15px 15px 100px 15px !important; max-width: 500px; margin: auto; position: relative; z-index: 1; }

    /* --- ‡∏´‡∏ô‡πâ‡∏≤ 3 ‡πÉ‡∏´‡∏°‡πà 40:30:30 --- */
    .p3-layout { display: flex; flex-direction: column; gap: 12px; }
    .history-section { display: flex; gap: 8px; width: 100%; }
    .history-col { flex: 1; background: var(--card); border-radius: 20px; border: 1.5px solid var(--border); padding: 10px; min-height: 200px; }

    /* --- ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏¥‡∏õ‡∏´‡∏ô‡πâ‡∏≤ 1 --- */
    .price-row { display: grid; grid-template-columns: 1.5fr 1fr; gap: 8px; margin-bottom: 12px; }
    .tip-input { background: #fff1f2 !important; border: 2.5px solid #fecdd3 !important; color: #be185d !important; height: 70px !important; font-size: 20px !important; }

    .nav-bar { position: fixed !important; bottom: 0; left: 0; right: 0; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; z-index: 9999; border-top: 1px solid #eee; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
    .nav-item.active { color: #6366f1; }
    .nav-item i { font-size: 22px; }
    .nav-item span { font-size: 12px; }

    .grid-3 { display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 6px; margin-bottom: 8px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
    .icon-card { border-radius: 15px; padding: 12px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; border: 1px solid var(--border); cursor: pointer; }
    
    input, select { width: 100%; height: 60px; border-radius: 14px; border: 1.5px solid var(--border); text-align: center; font-size: 16px; font-weight: 600; background: #f1f5f9; }
    .price-box { font-size: 55px !important; height: 90px !important; font-weight: 700 !important; border: 2px solid var(--primary) !important; color: var(--text); background: #fff; }
    
    .btn { border: none; padding: 12px; border-radius: 15px; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; }
    .btn-pay { background: #e2e8f0; color: #64748b; height: 65px; font-size: 18px; border: 2px solid transparent; }
    .btn-pay.active-cash { background: #dcfce7; color: #15803d; border-color: #22c55e; }
    .btn-pay.active-trans { background: #e0f2fe; color: #0369a1; border-color: #0ea5e9; }
    .btn-main { background: var(--primary); color: white; width: 100%; height: 80px; border-radius: 20px; font-size: 30px; margin-top: 10px; }

    .page { display: none; }
    .page.active { display: block; }
    .acc-main-card { background: white; padding: 20px; border-radius: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
    .btn-save { background: var(--success); color: white; border: none; width: 100%; padding: 15px; border-radius: 15px; font-weight: 700; }
    #accHistory { font-size: 12px; max-height: 150px; overflow-y: auto; }
</style>
</head>
<body>
<div class="container">
    <div id="p1" class="page active">
        <h2 id="shopNameDisp" style="text-align:center; color:var(--primary); margin: 10px 0;">Barber Shop</h2>
        
        <div class="grid-3">
            <div class="icon-card" style="background: #fffbeb; border-color: #fde68a;" onclick="handleInsurance()"><span>üõ°Ô∏è</span><span style="color: #b45309;">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</span></div>
            <div class="icon-card" style="background: #fff1f2; border-color: #fecdd3;" onclick="handleHoliday()"><span>üèñÔ∏è</span><span style="color: #be185d;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span></div>
            <div class="icon-card" style="background: #f1f5f9; border-color: #cbd5e1;" onclick="openSettings()"><span>‚öôÔ∏è</span><span style="color: #475569;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span></div>
        </div>

        <div class="grid-3">
            <div class="icon-card" style="background: #f1f5f9; border-color: #cbd5e1; padding: 1px; height: 55px; position: relative;">
                <span id="dateDisplay" style="font-size: 18px; font-weight: 700;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                <input type="date" id="dateInp" onchange="document.getElementById('dateDisplay').innerText = this.value; if(window.updateDateDisplay) updateDateDisplay(this.value)" style="position: absolute; top: 0; left: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2;">
            </div>
            <input type="time" id="tStart" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°" style="text-align:center; height: 50px;">
            <input type="time" id="tEnd" placeholder="‡πÄ‡∏™‡∏£‡πá‡∏à" style="text-align:center; height: 50px;">
        </div>

        <div style="display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 8px; margin-bottom: 12px;">
            <select id="hairStyle" style="height: 70px;">
                <option value="">üíá ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏£‡∏á‡∏ú‡∏°</option>
                <option value="‡πÄ‡∏î‡πá‡∏Å">üë∂ ‡∏ï‡∏±‡∏î‡∏ú‡∏°‡πÄ‡∏î‡πá‡∏Å</option>
                <option>‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á</option><option>‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô</option><option>‡∏™‡∏Å‡∏¥‡∏ô‡πÄ‡∏ü‡∏î</option><option>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á</option><option>‡∏ï‡∏≥‡∏£‡∏ß‡∏à/‡∏ó‡∏´‡∏≤‡∏£</option><option>‡∏ó‡∏£‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                <option>‡πÅ‡∏Å‡πâ‡∏ú‡∏°</option><option>‡πÇ‡∏Å‡∏ô‡∏ú‡∏°</option>
            </select>
            <select id="extra1" style="height: 50px;"><option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 1</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option></select>
            <select id="extra2" style="height: 50px;"><option value="">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 2</option><option>‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î</option><option>‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option><option>‡∏™‡∏£‡∏∞‡∏ú‡∏°</option><option>‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°</option></select>
        </div>

        <input type="number" id="priceInp" class="price-box" placeholder="0" inputmode="numeric">

        <div class="grid-2">
            <button id="btnCash" class="btn btn-pay" onclick="selectPay('Cash')">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
            <button id="btnTrans" class="btn btn-pay" onclick="selectPay('Trans')">üì± ‡πÇ‡∏≠‡∏ô</button>
        </div>
        <button class="btn btn-main" onclick="handleSave()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div> <div id="p2" class="page" style="padding: 15px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div style="background: white; padding:18px 15px; border-radius:20px; text-align:center; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                <small style="font-weight:800; color:#64748b; text-transform: uppercase;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                <div id="dTotal" style="font-size:36px; font-weight:900; color:#4338ca; margin: 5px 0;">0</div>
                <div id="dCounts" style="font-size:13px; font-weight:700; color:#1e293b; background:#e0e7ff; display:inline-block; padding:2px 10px; border-radius:10px;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 0 ‡∏Ñ‡∏ô</div>
            </div>

            <div style="background:white; padding:15px; border-radius:20px; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; display:flex; flex-direction:column; justify-content:center; gap:8px;">
                <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:#0ea5e9;">üì± ‡πÇ‡∏≠‡∏ô:</span> <b id="dTrans">0</b></div>
                <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:#f59e0b;">üíµ ‡∏™‡∏î:</span> <b id="dCash">0</b></div>
                <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700;"><span style="color:#6366f1;">ü§µ ‡∏ä‡πà‡∏≤‡∏á:</span> <b id="dBarber">0</b></div>
                <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:800;"><span style="color:#64748b;">üè† ‡∏£‡πâ‡∏≤‡∏ô:</span> <b id="dShop">0</b></div>
            </div>
        </div>
        <div id="settleBarContainer" style="margin-bottom:18px;">
            <div id="settleBar"></div> </div>
        <div id="dServiceStats"></div>
        <hr style="border:0; border-top:1px solid #e2e8f0; margin-top:15px;">
        <div id="dailyList"></div>
    </div> <div id="p3" class="page" style="padding: 15px;">
        <h2 style="text-align:center;">‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2>
        <div class="acc-main-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:16px; color:#b45309;"><i class="fas fa-wallet"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</h3>
                <div id="accLight" style="background:gray; width:12px; height:12px; border-radius:50%;"></div>
            </div>
            <div style="font-size:13px; color:#64748b; margin:15px 0; background:rgba(0,0,0,0.03); padding:12px; border-radius:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°:</span><b id="accOldVal">‡∏ø0</b></div>
                <div style="display:flex; justify-content:space-between;"><span>‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</span><b id="accTodayVal" style="color:var(--primary)">‡∏ø0</b></div>
            </div>
            <div style="text-align:center; margin:20px 0;">
                <div style="font-size:14px; opacity:0.6;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                <div style="font-size:48px; font-weight:900; color:var(--primary);">‡∏ø<span id="accNet">0</span></div>
            </div>
            <div id="accStatus" class="status-bar">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <button class="btn" onclick="toggleAccHistory()" style="width:100%; border:1px dashed var(--primary); background:#f0f7ff; color:var(--primary); margin-bottom:15px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô</button>
            <div id="accHistoryWrapper" style="display:none; margin-bottom:15px;"><div id="accHistory" class="card" style="font-size:12px; max-height:150px; overflow-y:auto;"></div></div>
            <div style="background:#f8fafc; padding:15px; border-radius:20px; border:1px solid var(--border);">
                <input type="date" id="accDate" style="margin-bottom:10px;">
                <input type="text" id="accNote" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥" style="margin-bottom:10px;">
                <button class="btn-save" onclick="clearAccount()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
        </div>

        <div class="card" style="margin-top:20px; padding: 15px;">
            <h2 style="text-align:center;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h2>
            <label>üìÖ ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
            <input type="month" id="histMonth" onchange="loadHistMonth()" style="margin:10px 0; width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
            <div id="histMonthArea"></div>
            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
            <label>üìÖ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</label>
            <input type="date" id="histDate" onchange="loadHistDaily()" style="margin:10px 0; width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
            <div id="histDailyArea"></div>
        </div>
    </div> </div> <div id="modalSet" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--primary); text-align: center;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3> 
        <label style="font-size:11px; font-weight:600;">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label> <input id="setShop" style="margin-bottom:10px;">
        <div class="grid-2">
            <div><label style="font-size:11px; font-weight:600;">% ‡∏ä‡πà‡∏≤‡∏á</label><input type="number" id="setPerc" placeholder="‡πÄ‡∏ä‡πà‡∏ô 50"></div>
            <div><label style="font-size:11px; font-weight:600;">‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô/‡∏ß‡∏±‡∏ô</label><input type="number" id="setGuar" placeholder="0"></div>
        </div>
        <div style="margin-top:10px">
            <label style="font-size:11px; font-weight:600;">‡∏ò‡∏µ‡∏°‡πÅ‡∏≠‡∏õ</label>
            <select id="setTheme">
                <option value="neon-light">üå§ Neon Light</option>
                <option value="deep-navy">üåå Deep Navy</option>
                <option value="barber-dark">üåë Barber Dark</option>
            </select>
        </div>
        <div class="grid-2" style="margin-top:10px">
            <div><label style="font-size:11px; font-weight:600;">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</label> <select id="setSound"><option value="on">üîä ‡πÄ‡∏õ‡∏¥‡∏î</option><option value="off">üîá ‡∏õ‡∏¥‡∏î</option></select></div>
            <div><label style="font-size:11px; font-weight:600;">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î</label><select id="setVoice"><option value="female">üë© ‡∏´‡∏ç‡∏¥‡∏á</option><option value="male">üë® ‡∏ä‡∏≤‡∏¢</option></select></div>
        </div>
        <div class="grid-2" style="margin-top:20px">
            <button class="btn" style="background:var(--primary); color:#fff" onclick="saveSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="btn" style="background:#e2e8f0; color:var(--text)" onclick="closeSettings()">‡∏õ‡∏¥‡∏î</button>
        </div>
        <button class="btn" style="width:100%; background:var(--danger); color:#fff; margin-top:10px; font-size:12px;" onclick="clearAllData()">‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
</div>

<nav class="nav-bar">
    <div class="nav-item active" id="n1" onclick="go(1)"><i class="fas fa-edit"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></div>
    <div class="nav-item" id="n2" onclick="go(2)"><i class="fas fa-file-invoice"></i><span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></div>
    <div class="nav-item" id="n3" onclick="go(3)"><i class="fas fa-wallet"></i><span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></div>
</nav>
 <script>
    let archives = JSON.parse(localStorage.getItem("barber_archives")) || [];
    function save() {localStorage.setItem("barber_archives", JSON.stringify(archives));}
    let db = JSON.parse(localStorage.getItem("barber_db")) || [];
    let conf = JSON.parse(localStorage.getItem("barber_conf")) || { shop: "Barber Shop", perc: 50, guar: 0 };
    let account = JSON.parse(localStorage.getItem("barber_account")) || { balance: 0, logs: [] };
    let payMethod = "";
    const $ = (id) => document.getElementById(id);
    window.onload = () => {
        const today = new Date().toISOString().split('T')[0];
        if($("dateInp")) $("dateInp").value = today;if($("accDate")) $("accDate").value = today;if($("histDate")) $("histDate").value = today;if($("shopNameDisp")) $("shopNameDisp").innerText = conf.shop;
        updateDateDisplay(today);
    };
    function addMinutes(time, mins) {
    if (!time) return "";
    const [h, m] = time.split(":").map(Number);
    const d = new Date();
    d.setHours(h, m + mins, 0, 0);
    return d.toTimeString().slice(0, 5);
}
    function handleSave() {
    const p = parseInt($("priceInp").value);
    if (!p || !payMethod) return alert("‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏à‡πä‡∏∞!");
    const start = $("tStart").value || new Date().toTimeString().slice(0, 5);
    const end = $("tEnd").value || addMinutes(start, 30); 
    const rec = {
        id: Date.now(),
        date: $("dateInp").value,
        time: start,
        endTime: end,  
        svcs: [
            $("hairStyle").value,
            $("extra1").value,
            $("extra2").value
        ].filter(Boolean),
        hair: $("hairStyle").value, 
        price: p,
        pay: payMethod, // 'Cash' ‡∏´‡∏£‡∏∑‡∏≠ 'Trans'
        type: "SERVICE"
    };
    db.push(rec);
    saveDB(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LocalStorage
    renderDay(); // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ 2 ‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    $("tStart").value = "";
    $("tEnd").value = "";
    $("priceInp").value = "";
}
function handleInsurance() {
    const today = $("dateInp").value || new Date().toISOString().split('T')[0];
    const guaranteeAmount = parseInt(conf.guar) || 0;

    const speak = (txt) => {
        const msg = new SpeechSynthesisUtterance(txt);
        msg.lang = 'th-TH';
        window.speechSynthesis.speak(msg);
    };
    if (guaranteeAmount <= 0) {
        speak("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"); // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö' ‡∏Å‡πà‡∏≠‡∏ô");
        return;
    }
    const alreadyGuar = db.find(r => r.date === today && r.type === "GUARANTEE_CLAIM");
    if (alreadyGuar) {
        speak("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞");
        alert("üõ°Ô∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö‡∏û‡∏µ‡πà");
        return;
    }
    if (confirm(`üõ°Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ'?`)) {
        db.push({ 
            id: Date.now(), 
            date: today, 
            time: "00:00", 
            svcs: ["üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô"], 
            price: 0, 
            pay: "N/A",
            type: "GUARANTEE_CLAIM" 
        });

        saveDB(); 
        speak(`‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ${guaranteeAmount} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        alert("‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        renderDay();
    }
}
   function handleHoliday() {
    const today = $("dateInp").value;
    if (!today) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
    const speak = (txt) => {
    const msg = new SpeechSynthesisUtterance(txt);
        msg.lang = 'th-TH';
        window.speechSynthesis.speak(msg);
    };
    if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${today} ‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"?`)) {
        const holidayRecord = {
            id: Date.now(),
            date: today,
            time: "00:00",
            svcs: ["üèñÔ∏è ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î"], // ‡πÉ‡∏™‡πà‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î
            price: 0,
            pay: "N/A",
            type: "HOLIDAY" // ‡∏°‡∏≤‡∏£‡πå‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≥‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
        };
        db.push(holidayRecord);
        saveDB();
        speak("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"); // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î
        alert("üèñÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        renderDay();
    }
}
    function openSettings() {
        const modal = $("modalSet");
        if (modal) {
            $("setShop").value = conf.shop || "";
            $("setPerc").value = conf.perc || 50;
            $("setGuar").value = conf.guar || 0;
            modal.style.display = 'flex'; 
        }
    }
    function saveSettings() {
    conf.shop = $("setShop").value;
    conf.perc = parseInt($("setPerc").value);
    conf.guar = parseInt($("setGuar").value);
    conf.theme = $("setTheme").value;
    conf.sound = $("setSound").value;
    conf.voice = $("setVoice").value;
    conf.bright = $("setBright").value;

    localStorage.setItem("barber_conf", JSON.stringify(conf));
    
    applyTheme(conf.theme);
    changeBrightness(conf.bright);
    $("shopNameDisp").innerText = conf.shop;
    
    speak("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    closeSettings();
}
    function closeSettings() {
        if ($("modalSet")) $("modalSet").style.display = 'none';
    }
    function applyTheme(themeName) {
    document.body.className = themeName;
     }
    function speak(text) {
    if (conf.sound === 'off') return;
    window.speechSynthesis.cancel();
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'th-TH';
    msg.pitch = (conf.voice === 'male') ? 0.8 : 1.2;
    window.speechSynthesis.speak(msg);
    }
    function clearAllData() {
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏ñ‡∏≤‡∏ß‡∏£!")) {
            localStorage.clear();
            location.reload();
        }
    }
function updateDateDisplay(val) {
    if (!val) return; // ‡∏Å‡∏±‡∏ô Error ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
    const d = new Date(val);
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô "20 ‡∏°.‡∏Ñ."
    document.getElementById("dateDisplay").innerText = d.toLocaleDateString('th-TH', { 
        day: 'numeric', 
        month: 'short',
        year: '2-digit' // ‡πÅ‡∏ñ‡∏°: ‡πÉ‡∏™‡πà‡∏õ‡∏µ‡∏ó‡πâ‡∏≤‡∏¢‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå
    });
    if (typeof renderDay === "function") renderDay();
}
window.addEventListener('DOMContentLoaded', () => {
    const dateInp = document.getElementById("dateInp");
    const now = new Date();
    const today = now.getFullYear() + '-' + 
                  String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                  String(now.getDate()).padStart(2, '0');
    
    dateInp.value = today;       // ‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏•‡∏á‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
    updateDateDisplay(today);    // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô
});

    function selectPay(m) {
        payMethod = m;
        $("btnCash").className = `btn btn-pay ${m === 'Cash' ? 'active-cash' : ''}`;
        $("btnTrans").className = `btn btn-pay ${m === 'Trans' ? 'active-trans' : ''}`;
    }
function renderDay() {
    const dInp = $("dateInp").value;
    const today = db.filter(r => r.date === dInp);
    let tot = 0, trans = 0, cash = 0, stats = {}, listHtml = "";

    today.slice().sort((a, b) => a.time.localeCompare(b.time)).forEach((r, idx) => {
        tot += r.price;
        r.pay === 'Trans' ? trans += r.price : cash += r.price;

        const counted = new Set();
        counted.add("‡∏ï‡∏±‡∏î‡∏ú‡∏°");
        if (r.hair && r.hair.includes("‡πÄ‡∏î‡πá‡∏Å")) counted.add("‡πÄ‡∏î‡πá‡∏Å");
        (r.svcs || []).forEach(s => {
            if (!s || s.includes("‡πÄ‡∏î‡πá‡∏Å") || s.includes("‡∏£‡∏≠‡∏á‡∏ó‡∏£‡∏á") || s.includes("‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô") || s.includes("‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô") || s.includes("‡∏ï‡∏±‡∏î‡∏ú‡∏°")) return;
            counted.add(s);
        });
        counted.forEach(k => stats[k] = (stats[k] || 0) + 1);

        const timeShow = r.endTime ? `${r.time} - ${r.endTime}` : r.time;

        // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö 1. 2. 3.
        listHtml += `
        <div class="history-row" style="padding:15px; border-bottom:1px solid #f1f5f9; background:#fff;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:800; font-size:14px; color:#1e293b;">
                    ${idx + 1}. [${timeShow}] | ${(r.svcs || []).join('+')}
                </span>
                <div style="text-align:right;">
                    <b style="font-size:16px; display:block;">‡∏ø${r.price}</b>
                    <span style="font-size:12px; font-weight:700;">
                        ${r.pay === 'Trans' ? 'üì± ‡πÇ‡∏≠‡∏ô' : 'üíµ ‡∏™‡∏î'} 
                        <i class="fas fa-trash-alt" style="color:#ef4444; cursor:pointer; margin-left:8px;" onclick="delRec(${r.id})"></i>
                    </span>
                </div>
            </div>
        </div>`;
    });

    const bEarn = Math.max(tot * (conf.perc / 100), conf.guar), sEarn = tot - bEarn, settle = cash - bEarn;

    $("dTotal").innerText = tot.toLocaleString();
    $("dTrans").innerText = trans.toLocaleString();
    $("dCash").innerText = cash.toLocaleString(); // ‡∏¢‡∏≠‡∏î‡∏™‡∏î‡πÅ‡∏¢‡∏Å‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏ó‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    $("dBarber").innerText = Math.floor(bEarn).toLocaleString(); // ‡∏¢‡∏≠‡∏î‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏ß‡πÜ
    $("dShop").innerText = Math.floor(sEarn).toLocaleString();
    $("dCounts").innerText = `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${today.length} ‡∏Ñ‡∏ô`;

    let sH = `<div style="display:flex; flex-wrap:wrap; gap:5px; justify-content:center; margin-bottom:10px;">`;
    ["‡∏ï‡∏±‡∏î‡∏ú‡∏°", "‡πÄ‡∏î‡πá‡∏Å"].forEach(k => { if (stats[k]) sH += `<span style="background:#4338ca;color:#fff;padding:5px 12px;border-radius:8px;font-size:11px;font-weight:800;">${k}: ${stats[k]}</span>`; });
    for (let s in stats) { if (!["‡∏ï‡∏±‡∏î‡∏ú‡∏°", "‡πÄ‡∏î‡πá‡∏Å"].includes(s)) sH += `<span style="background:#64748b;color:#fff;padding:5px 12px;border-radius:8px;font-size:11px;font-weight:800;">${s}: ${stats[s]}</span>`; }
    $("dServiceStats").innerHTML = sH + `</div>`;

    // ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô Barber Shop ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
    $("dailyList").innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin:10px 0; padding:0 5px;">
        <b style="font-size:16px;">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</b>
        <i class="fab fa-line" style="color:#22c55e;font-size:32px;cursor:pointer" onclick="shareLine()"></i>
    </div>` + (listHtml || "<center style='padding:40px; opacity:0.3;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</center>");

    let statusTxt = "", bgBar = "";
    if (tot === 0) { statusTxt = "üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô"; bgBar = "#e0f2fe"; }
    else if (settle > 0) { statusTxt = `üü• ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ‡∏ø${settle.toLocaleString()}`; bgBar = "#fee2e2"; }
    else if (settle < 0) { statusTxt = `üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ‡∏ø${Math.abs(settle).toLocaleString()}`; bgBar = "#e0e7ff"; }
    else { statusTxt = "‚úÖ ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ"; bgBar = "#dcfce7"; }

    const container = $("settleBar").parentElement;
    container.style.display = "flex"; container.style.gap = "10px"; container.style.marginTop = "10px";
    container.innerHTML = `
        <div id="settleBar" style="flex:8; height:55px; background:${bgBar}; display:flex; align-items:center; justify-content:center; border-radius:15px; font-weight:900; font-size:15px; color:#1e293b; border:1px solid rgba(0,0,0,0.05);">
            ${statusTxt}
        </div>
        <button onclick="saveAndGo('${dInp}', ${tot}, ${sEarn}, ${bEarn})" style="flex:2; height:55px; background:#f97316; color:#fff; border-radius:15px; border:none; font-size:22px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <i class="fas fa-paper-plane"></i>
        </button>`;
}

function saveAndGo(date, total, shop, barber) {
    const todayData = db.filter(r => r.date === date);
    if (total === 0 && !confirm("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡∏°‡∏±‡πâ‡∏¢?")) return;

    let todayStats = {};
    todayData.forEach(r => {
        r.svcs.forEach(s => todayStats[s] = (todayStats[s] || 0) + 1);
        if(r.hair) todayStats["‡∏ó‡∏£‡∏á:" + r.hair] = (todayStats["‡∏ó‡∏£‡∏á:" + r.hair] || 0) + 1;
    });

    const entry = {
        date: date, total: total, barber: barber, shop: total - barber,
        count: todayData.length, stats: todayStats
    };

    const idx = archives.findIndex(a => a.date === date);
    if(idx > -1) archives[idx] = entry; else archives.push(entry);
    
    save(); 
    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    go(3); 
}
    function toggleAccHistory() {
        const w = $("accHistoryWrapper");
        w.style.display = w.style.display === "none" ? "block" : "none";
        $("accHistory").innerHTML = account.logs.map(l => `<div style="padding:5px; border-bottom:1px solid #eee;">${l.date}: ‡∏ø${l.amount} (${l.note})</div>`).join('') || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥";
    }

   function loadHistDaily() {const d = $("histDate").value; const found = archives.find(a => a.date === d); const area = $("histDailyArea"); 
    if(!found) { area.innerHTML = "<center style='color:#ccc; padding:40px;'>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</center>"; return; }
    let rows = found.details.map(r => `
        <div class="history-row" style="font-size:13px; padding:10px 0; border-bottom:1px solid #f1f5f9;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b style="color:#1e293b;">${r.time} | ${r.svcs.join('+')}</b> 
                <b style="color:#1e293b;">‡∏ø${r.price}</b>
            </div>
            <div style="font-size:12px; font-weight:600; color:#64748b; margin-top:4px;">
                ${r.hair || '-'} 
                <span style="font-weight:400; opacity:0.6; float:right;">(${r.pay==='Cash'?'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î':'üì± ‡πÇ‡∏≠‡∏ô'})</span>
            </div>
        </div>`).join('');

    // 2. ‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (Badge)
    let statBadges = ""; if (found.stats) { for(let s in found.stats) { let bg = s.startsWith("‡∏ó‡∏£‡∏á:") ? "#10b981" : "#6366f1"; statBadges += `<span class="badge" style="background:${bg}; color:#fff; margin:2px; padding:4px 8px; border-radius:6px; font-size:11px;">${s.replace("‡∏ó‡∏£‡∏á:","")}: ${found.stats[s]}</span>`; 
        } 
    }
    const settle = found.settle || 0;
    const settleText = settle > 0 ? `üî¥ ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô: ‡∏ø${Math.floor(settle).toLocaleString()}` : settle < 0 ? `üîµ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á: ‡∏ø${Math.floor(Math.abs(settle)).toLocaleString()}` : "üü¢ ‡∏¢‡∏≠‡∏î‡∏û‡∏≠‡∏î‡∏µ‡πÄ‡∏õ‡πä‡∏∞";
    const settleClass = settle > 0 ? "status-red" : settle < 0 ? "status-indigo" : "status-green";

    area.innerHTML = `
    <div style="background:#fff; padding:15px; border-radius:20px; border:1px solid #e2e8f0; margin-top:10px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);">
        <div class="status-bar ${settleClass}" style="padding:10px; font-size:14px; margin-bottom:15px; border-radius:12px; font-weight:900; text-align:center;">
            ${settleText}
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px; font-size:13px;">
            <div style="background:#f8fafc; padding:10px; border-radius:10px; border:1px solid #f1f5f9;">‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡∏î: <b>${found.total.toLocaleString()}</b></div>
            <div style="background:#f8fafc; padding:10px; border-radius:10px; border:1px solid #f1f5f9;">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î: <b>${found.cash.toLocaleString()}</b></div>
            <div style="background:#f0fdf4; padding:10px; border-radius:10px; color:#166534;">‡∏ä‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ: <b>${Math.floor(found.barber).toLocaleString()}</b></div>
            <div style="background:#eff6ff; padding:10px; border-radius:10px; color:#1e40af;">‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ: <b>${Math.floor(found.shop).toLocaleString()}</b></div>
        </div>

        <div style="margin-bottom:15px; display:flex; flex-wrap:wrap; gap:4px;">${statBadges}</div>
        <div style="border-top:2px dashed #f1f5f9; padding-top:10px;">${rows}</div>
    </div>`;
}
  function loadHistMonth() {
    const m = $("histMonth").value; 
    const area = $("histMonthArea"); 
    if(!m) return;
    
    const filtered = archives.filter(a => a.date.startsWith(m));
    if(!filtered.length) { 
        area.innerHTML = "<center style='color:#ccc; padding:40px;'>üåë ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</center>"; 
        return; 
    }

    let mTotal = 0, mBarber = 0, mShop = 0, mCount = 0, mStats = {};
    filtered.forEach(a => { 
        mTotal += a.total; 
        mBarber += a.barber; 
        mShop += (a.total - a.barber); 
        mCount += a.count; 
        if(a.stats) { for(let s in a.stats) mStats[s] = (mStats[s] || 0) + a.stats[s]; } 
    });

    let sB = "", hB = "";
    for(let s in mStats) { 
        if(s.startsWith("‡∏ó‡∏£‡∏á:")) hB += `<span class="badge" style="background:#10b981; color:white; padding:4px 8px; border-radius:6px; margin:2px; font-size:11px;">${s.replace("‡∏ó‡∏£‡∏á:","")}: ${mStats[s]}</span>`; 
        else sB += `<span class="badge" style="background:#6366f1; color:white; padding:4px 8px; border-radius:6px; margin:2px; font-size:11px;">${s}: ${mStats[s]}</span>`; 
    }
    area.innerHTML = `
    <div style="padding:15px; background:#fff; border-radius:20px; border:1px solid #e2e8f0; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);">
        <div style="text-align:center; margin-bottom:20px; padding:15px; background:linear-gradient(to bottom, #fff, #f8fafc); border-radius:15px; border:1px solid #f1f5f9;">
            <div style="font-size:12px; color:#64748b; font-weight:bold; margin-bottom:5px;">‚úÇÔ∏è ‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            <div style="font-size:32px; font-weight:900; color:#1e293b;">‡∏ø${mTotal.toLocaleString()}</div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
            <div style="background:#f0fdf4; padding:15px; border-radius:15px; text-align:center; border:1px solid #dcfce7;">
                <div style="font-size:11px; color:#166534; font-weight:bold;">ü§µ ‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏ß‡∏°</div>
                <div style="font-size:20px; font-weight:900; color:#15803d;">‡∏ø${Math.floor(mBarber).toLocaleString()}</div>
            </div>
            <div style="background:#eff6ff; padding:15px; border-radius:15px; text-align:center; border:1px solid #dbeafe;">
                <div style="font-size:11px; color:#1e40af; font-weight:bold;">üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏ß‡∏°</div>
                <div style="font-size:20px; font-weight:900; color:#1e40af;">‡∏ø${Math.floor(mShop).toLocaleString()}</div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-around; font-size:13px; margin-bottom:20px; padding:10px; background:#f8fafc; border-radius:12px;">
            <div>üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <b>${mCount} ‡∏Ñ‡∏ô</b></div>
            <div style="color:#e2e8f0;">|</div>
            <div>üìÖ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: <b>${filtered.length} ‡∏ß‡∏±‡∏ô</b></div>
        </div>
        <div style="border-top:2px dashed #f1f5f9; padding-top:15px;">
            <label style="font-size:12px; color:#1e293b; font-weight:900;">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:</label>
            <div style="margin:8px 0 15px 0; display:flex; flex-wrap:wrap; gap:2px;">${sB || '-'}</div>
            <label style="font-size:12px; color:#1e293b; font-weight:900;">üíá ‡∏ó‡∏£‡∏á‡∏ú‡∏°‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï:</label>
            <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:2px;">${hB || '-'}</div>
        </div>
    </div>`;
    }
function shareLine() {
    const dInp = $("dateInp").value; // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ 2026-01-22
    const today = db.filter(r => r.date === dInp);
    if (!today.length) return;

    // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1: ‡∏¢‡πâ‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡∏´‡∏ô‡πâ‡∏≤ ‡∏û.‡∏®. (22/01/2026) ---
    const dateParts = dInp.split('-');
    const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;

    let tot = 0, cash = 0, trans = 0, stats = {};
    let clientList = today.sort((a,b) => a.time.localeCompare(b.time)).map((r, i) => {
        tot += r.price; r.pay === 'Trans' ? trans += r.price : cash += r.price;
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
        if (r.hair && r.hair.includes("‡πÄ‡∏î‡πá‡∏Å")) stats["‡πÄ‡∏î‡πá‡∏Å"] = (stats["‡πÄ‡∏î‡πá‡∏Å"] || 0) + 1;
        (r.svcs || []).forEach(s => {
            if (!s) return;
            stats[s] = (stats[s] || 0) + 1;
        });
        const tShow = r.endTime ? `${r.time}-${r.endTime}` : r.time;
        return `${i+1}. [${tShow}] ${(r.svcs || []).join('+')} = ${r.price} ${r.pay === 'Trans' ? 'üì±' : 'üíµ'}`;
    }).join('\n');
    const allowedStats = ["‡πÄ‡∏î‡πá‡∏Å", "‡∏™‡∏£‡∏∞‡∏ú‡∏°", "‡πÇ‡∏Å‡∏ô‡∏´‡∏ô‡∏ß‡∏î", "‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°", "‡∏¢‡πâ‡∏≠‡∏°‡∏™‡∏µ"];
    let statText = Object.entries(stats)
        .filter(([k]) => allowedStats.some(a => k.includes(a))) // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á
        .map(([k, v]) => {
            let icon = "üîπ";
            if (k.includes("‡πÄ‡∏î‡πá‡∏Å")) icon = "üßí";
            else if (k.includes("‡∏™‡∏£‡∏∞")) icon = "üßº";
            else if (k.includes("‡πÇ‡∏Å‡∏ô")) icon = "ü™í";
            else if (k.includes("‡∏¢‡πâ‡∏≠‡∏°")) icon = "üé®";
            return `${icon} ${k}: ${v}`;
        }).join('\n');
    
    let bEarn = Math.max(tot * (conf.perc / 100), conf.guar);
    let settle = cash - bEarn;
    let settleMsg = settle > 0 ? `‚ö†Ô∏è ‡∏ä‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô‡∏£‡πâ‡∏≤‡∏ô ${Math.floor(Math.abs(settle))}` : `üü¶ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏ô‡∏ä‡πà‡∏≤‡∏á ${Math.floor(Math.abs(settle))}`;
    
    let msg = `üíà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô: Barber Shop\nüìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formattedDate}\n-------------------------\nüìù ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏ß‡∏° ${today.length} ‡∏Ñ‡∏ô):\n${clientList}\n-------------------------\nüìä ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô:\n${statText}\n-------------------------\nüí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${tot}\nüì± ‡πÇ‡∏≠‡∏ô: ${trans} | üíµ ‡∏™‡∏î: ${cash}\nü§µ ‡∏ä‡πà‡∏≤‡∏á: ${Math.floor(bEarn)}\nüè† ‡∏£‡πâ‡∏≤‡∏ô: ${Math.floor(tot - bEarn)}\n-------------------------\n${settleMsg}`;
    
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(msg)}`);
}
    function saveDB() { localStorage.setItem("barber_db", JSON.stringify(db)); localStorage.setItem("barber_conf", JSON.stringify(conf)); }
    function go(n) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); if(document.getElementById('p'+n)) document.getElementById('p'+n).classList.add('active'); if(document.getElementById('n'+n)) document.getElementById('n'+n).classList.add('active'); renderDay(); }
    function delRec(id) { if (confirm("‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö‡∏û‡∏µ‡πà?")) { db = db.filter(r => r.id !== id); saveDB(); renderDay(); } }
    function editTime(id) {const rec = db.find(r => r.id === id);if (!rec) return;const newStart = prompt("‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (HH:MM)", rec.time);if (!newStart) return;const newEnd = prompt("‡πÅ‡∏Å‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à (HH:MM)", rec.endTime || "");rec.time = newStart;rec.endTime = newEnd || addMinutes(newStart, 30);saveDB();renderDay();}

  
</script>
</body>
</html>
